<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: AnimationManager.js | egjs::axes - API</title>
    
    <meta name="description" content="A module used to change the information of user action entered by various input devices such as touch screen or mouse into the logical virtual coordinates. You can easily create a UI that responds to user actions." />
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <link rel="canonical" href="http://naver.github.io/egjs-axes/release/latest/doc/"/>
    
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"eg.Axes","disqus":"egjs","googleAnalytics":"UA-70842526-16","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"egjs::axes - API","description":"A module used to change the information of user action entered by various input devices such as touch screen or mouse into the logical virtual coordinates. You can easily create a UI that responds to user actions.","keyword":""},"linenums":true,"link":{"canonical":"http://naver.github.io/egjs-axes/release/latest/doc/"}};
    </script>
    

    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', config.googleAnalytics]);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName">
        <a href="//naver.github.io/egjs/"><img style="width:40px; height:20px;" src="img/type_white.svg"/></a>

        <!-- Homepage link (prefer link.home than applicationName) -->
        
        <a href="//naver.github.io/egjs-axes/">Axes</a>
        
    </h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
        <li class="item">
            <span class="title">
                <a href="index.html">README</a>
            </span>
        </li>
    
        <!-- Non Grouping Version -->
        
            

<li class="item" data-name="eg.Axes">
    <span class="title">
        <a href="eg.Axes.html">eg.Axes</a>
        
    </span>
    <ul class="members itemMembers expends">
    
    <span class="subtitle">Members</span>
    
        <li data-name="eg.Axes.DIRECTION_ALL"><a href="eg.Axes.html#.DIRECTION_ALL">DIRECTION_ALL</a></li>
    
        <li data-name="eg.Axes.DIRECTION_DOWN"><a href="eg.Axes.html#.DIRECTION_DOWN">DIRECTION_DOWN</a></li>
    
        <li data-name="eg.Axes.DIRECTION_HORIZONTAL"><a href="eg.Axes.html#.DIRECTION_HORIZONTAL">DIRECTION_HORIZONTAL</a></li>
    
        <li data-name="eg.Axes.DIRECTION_LEFT"><a href="eg.Axes.html#.DIRECTION_LEFT">DIRECTION_LEFT</a></li>
    
        <li data-name="eg.Axes.DIRECTION_NONE"><a href="eg.Axes.html#.DIRECTION_NONE">DIRECTION_NONE</a></li>
    
        <li data-name="eg.Axes.DIRECTION_RIGHT"><a href="eg.Axes.html#.DIRECTION_RIGHT">DIRECTION_RIGHT</a></li>
    
        <li data-name="eg.Axes.DIRECTION_UP"><a href="eg.Axes.html#.DIRECTION_UP">DIRECTION_UP</a></li>
    
        <li data-name="eg.Axes.DIRECTION_VERTICAL"><a href="eg.Axes.html#.DIRECTION_VERTICAL">DIRECTION_VERTICAL</a></li>
    
        <li data-name="eg.Axes.TRANSFORM"><a href="eg.Axes.html#.TRANSFORM">TRANSFORM</a></li>
    
        <li data-name="eg.Axes.VERSION"><a href="eg.Axes.html#.VERSION">VERSION</a></li>
    
    </ul>
    <ul class="typedefs itemMembers expends">
    
    </ul>
    <ul class="methods itemMembers expends">
    
    <span class="subtitle">Methods</span>
    
        <li data-name="eg.Axes#connect"><a href="eg.Axes.html#connect">connect</a></li>
    
        <li data-name="eg.Axes#destroy"><a href="eg.Axes.html#destroy">destroy</a></li>
    
        <li data-name="eg.Axes#disconnect"><a href="eg.Axes.html#disconnect">disconnect</a></li>
    
        <li data-name="eg.Axes#get"><a href="eg.Axes.html#get">get</a></li>
    
        <li data-name="eg.Axes#isBounceArea"><a href="eg.Axes.html#isBounceArea">isBounceArea</a></li>
    
        <li data-name="eg.Axes#setBy"><a href="eg.Axes.html#setBy">setBy</a></li>
    
        <li data-name="eg.Axes#setTo"><a href="eg.Axes.html#setTo">setTo</a></li>
    
    </ul>
    <ul class="events itemMembers expends">
    
    <span class="subtitle">Events</span>
    
        <li data-name="eg.Axes#event:animationEnd"><a href="eg.Axes.html#event:animationEnd">animationEnd</a></li>
    
        <li data-name="eg.Axes#event:animationStart"><a href="eg.Axes.html#event:animationStart">animationStart</a></li>
    
        <li data-name="eg.Axes#event:change"><a href="eg.Axes.html#event:change">change</a></li>
    
        <li data-name="eg.Axes#event:finish"><a href="eg.Axes.html#event:finish">finish</a></li>
    
        <li data-name="eg.Axes#event:hold"><a href="eg.Axes.html#event:hold">hold</a></li>
    
        <li data-name="eg.Axes#event:release"><a href="eg.Axes.html#event:release">release</a></li>
    
    </ul>

    
</li>

        
            

<li class="item" data-name="eg.Axes.MoveKeyInput">
    <span class="title">
        <a href="eg.Axes.MoveKeyInput.html">eg.Axes.MoveKeyInput</a>
        
    </span>
    <ul class="members itemMembers expends">
    
    </ul>
    <ul class="typedefs itemMembers expends">
    
    </ul>
    <ul class="methods itemMembers expends">
    
    <span class="subtitle">Methods</span>
    
        <li data-name="eg.Axes.MoveKeyInput#destroy"><a href="eg.Axes.MoveKeyInput.html#destroy">destroy</a></li>
    
        <li data-name="eg.Axes.MoveKeyInput#disable"><a href="eg.Axes.MoveKeyInput.html#disable">disable</a></li>
    
        <li data-name="eg.Axes.MoveKeyInput#enable"><a href="eg.Axes.MoveKeyInput.html#enable">enable</a></li>
    
        <li data-name="eg.Axes.MoveKeyInput#isEnable"><a href="eg.Axes.MoveKeyInput.html#isEnable">isEnable</a></li>
    
    </ul>
    <ul class="events itemMembers expends">
    
    </ul>

    
</li>

        
            

<li class="item" data-name="eg.Axes.PanInput">
    <span class="title">
        <a href="eg.Axes.PanInput.html">eg.Axes.PanInput</a>
        
    </span>
    <ul class="members itemMembers expends">
    
    </ul>
    <ul class="typedefs itemMembers expends">
    
    </ul>
    <ul class="methods itemMembers expends">
    
    <span class="subtitle">Methods</span>
    
        <li data-name="eg.Axes.PanInput#destroy"><a href="eg.Axes.PanInput.html#destroy">destroy</a></li>
    
        <li data-name="eg.Axes.PanInput#disable"><a href="eg.Axes.PanInput.html#disable">disable</a></li>
    
        <li data-name="eg.Axes.PanInput#enable"><a href="eg.Axes.PanInput.html#enable">enable</a></li>
    
        <li data-name="eg.Axes.PanInput#isEnable"><a href="eg.Axes.PanInput.html#isEnable">isEnable</a></li>
    
    </ul>
    <ul class="events itemMembers expends">
    
    </ul>

    
</li>

        
            

<li class="item" data-name="eg.Axes.PinchInput">
    <span class="title">
        <a href="eg.Axes.PinchInput.html">eg.Axes.PinchInput</a>
        
    </span>
    <ul class="members itemMembers expends">
    
    </ul>
    <ul class="typedefs itemMembers expends">
    
    </ul>
    <ul class="methods itemMembers expends">
    
    <span class="subtitle">Methods</span>
    
        <li data-name="eg.Axes.PinchInput#destroy"><a href="eg.Axes.PinchInput.html#destroy">destroy</a></li>
    
        <li data-name="eg.Axes.PinchInput#disable"><a href="eg.Axes.PinchInput.html#disable">disable</a></li>
    
        <li data-name="eg.Axes.PinchInput#enable"><a href="eg.Axes.PinchInput.html#enable">enable</a></li>
    
        <li data-name="eg.Axes.PinchInput#isEnable"><a href="eg.Axes.PinchInput.html#isEnable">isEnable</a></li>
    
    </ul>
    <ul class="events itemMembers expends">
    
    </ul>

    
</li>

        
            

<li class="item" data-name="eg.Axes.RotatePanInput">
    <span class="title">
        <a href="eg.Axes.RotatePanInput.html">eg.Axes.RotatePanInput</a>
        
    </span>
    <ul class="members itemMembers expends">
    
    </ul>
    <ul class="typedefs itemMembers expends">
    
    </ul>
    <ul class="methods itemMembers expends">
    
    <span class="subtitle">Methods</span>
    
        <li data-name="eg.Axes.RotatePanInput#destroy"><a href="eg.Axes.RotatePanInput.html#destroy">destroy</a> <img src="img/i.png" width="14" title="inherited" alt="inherited"></li>
    
        <li data-name="eg.Axes.RotatePanInput#disable"><a href="eg.Axes.RotatePanInput.html#disable">disable</a> <img src="img/i.png" width="14" title="inherited" alt="inherited"></li>
    
        <li data-name="eg.Axes.RotatePanInput#enable"><a href="eg.Axes.RotatePanInput.html#enable">enable</a> <img src="img/i.png" width="14" title="inherited" alt="inherited"></li>
    
        <li data-name="eg.Axes.RotatePanInput#isEnable"><a href="eg.Axes.RotatePanInput.html#isEnable">isEnable</a> <img src="img/i.png" width="14" title="inherited" alt="inherited"></li>
    
    </ul>
    <ul class="events itemMembers expends">
    
    </ul>

    
</li>

        
            

<li class="item" data-name="eg.Axes.WheelInput">
    <span class="title">
        <a href="eg.Axes.WheelInput.html">eg.Axes.WheelInput</a>
        
    </span>
    <ul class="members itemMembers expends">
    
    </ul>
    <ul class="typedefs itemMembers expends">
    
    </ul>
    <ul class="methods itemMembers expends">
    
    <span class="subtitle">Methods</span>
    
        <li data-name="eg.Axes.WheelInput#destroy"><a href="eg.Axes.WheelInput.html#destroy">destroy</a></li>
    
        <li data-name="eg.Axes.WheelInput#disable"><a href="eg.Axes.WheelInput.html#disable">disable</a></li>
    
        <li data-name="eg.Axes.WheelInput#enable"><a href="eg.Axes.WheelInput.html#enable">enable</a></li>
    
        <li data-name="eg.Axes.WheelInput#isEnable"><a href="eg.Axes.WheelInput.html#isEnable">isEnable</a></li>
    
    </ul>
    <ul class="events itemMembers expends">
    
    </ul>

    
</li>

        
    
    </ul>
</div>

    <div class="main">
        <h1 class="page-title" data-filename="AnimationManager.js.html">Source: AnimationManager.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var __assign = (this &amp;&amp; this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i &lt; n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
import { getInsidePosition, isCircularable, getCirculatedPos, getDuration } from "./Coordinate";
import { requestAnimationFrame, cancelAnimationFrame, map, every, filter, equal, roundNumber, getDecimalPlace, inversePow } from "./utils";
function minMax(value, min, max) {
    return Math.max(Math.min(value, max), min);
}
var AnimationManager = /** @class */ (function () {
    function AnimationManager(_a) {
        var options = _a.options, itm = _a.itm, em = _a.em, axm = _a.axm;
        this.options = options;
        this.itm = itm;
        this.em = em;
        this.axm = axm;
        this.animationEnd = this.animationEnd.bind(this);
    }
    AnimationManager.prototype.getDuration = function (depaPos, destPos, wishDuration) {
        var _this = this;
        var duration;
        if (typeof wishDuration !== "undefined") {
            duration = wishDuration;
        }
        else {
            var durations_1 = map(destPos, function (v, k) { return getDuration(Math.abs(v - depaPos[k]), _this.options.deceleration); });
            duration = Object.keys(durations_1).reduce(function (max, v) { return Math.max(max, durations_1[v]); }, -Infinity);
        }
        return minMax(duration, this.options.minimumDuration, this.options.maximumDuration);
    };
    AnimationManager.prototype.createAnimationParam = function (pos, duration, option) {
        var depaPos = this.axm.get();
        var destPos = pos;
        var inputEvent = option &amp;&amp; option.event || null;
        return {
            depaPos: depaPos,
            destPos: destPos,
            duration: minMax(duration, this.options.minimumDuration, this.options.maximumDuration),
            delta: this.axm.getDelta(depaPos, destPos),
            inputEvent: inputEvent,
            input: option &amp;&amp; option.input || null,
            isTrusted: !!inputEvent,
            done: this.animationEnd,
        };
    };
    AnimationManager.prototype.grab = function (axes, option) {
        if (this._animateParam &amp;&amp; axes.length) {
            var orgPos_1 = this.axm.get(axes);
            var pos = this.axm.map(orgPos_1, function (v, opt) { return getCirculatedPos(v, opt.range, opt.circular); });
            if (!every(pos, function (v, k) { return orgPos_1[k] === v; })) {
                this.em.triggerChange(pos, false, orgPos_1, option, !!option);
            }
            this._animateParam = null;
            this._raf &amp;&amp; cancelAnimationFrame(this._raf);
            this._raf = null;
            this.em.triggerAnimationEnd(!!(option &amp;&amp; option.event));
        }
    };
    AnimationManager.prototype.getEventInfo = function () {
        if (this._animateParam &amp;&amp; this._animateParam.input &amp;&amp; this._animateParam.inputEvent) {
            return {
                input: this._animateParam.input,
                event: this._animateParam.inputEvent,
            };
        }
        else {
            return null;
        }
    };
    AnimationManager.prototype.restore = function (option) {
        var pos = this.axm.get();
        var destPos = this.axm.map(pos, function (v, opt) { return Math.min(opt.range[1], Math.max(opt.range[0], v)); });
        this.animateTo(destPos, this.getDuration(pos, destPos), option);
    };
    AnimationManager.prototype.animationEnd = function () {
        var beforeParam = this.getEventInfo();
        this._animateParam = null;
        // for Circular
        var circularTargets = this.axm.filter(this.axm.get(), function (v, opt) { return isCircularable(v, opt.range, opt.circular); });
        Object.keys(circularTargets).length > 0 &amp;&amp; this.setTo(this.axm.map(circularTargets, function (v, opt) { return getCirculatedPos(v, opt.range, opt.circular); }));
        this.itm.setInterrupt(false);
        this.em.triggerAnimationEnd(!!beforeParam);
        if (this.axm.isOutside()) {
            this.restore(beforeParam);
        }
        else {
            this.finish(!!beforeParam);
        }
    };
    AnimationManager.prototype.finish = function (isTrusted) {
        this._animateParam = null;
        this.itm.setInterrupt(false);
        this.em.triggerFinish(isTrusted);
    };
    AnimationManager.prototype.animateLoop = function (param, complete) {
        if (param.duration) {
            this._animateParam = __assign({}, param);
            var info_1 = this._animateParam;
            var self_1 = this;
            var destPos_1 = info_1.destPos;
            var prevPos_1 = info_1.depaPos;
            var prevEasingPer_1 = 0;
            var directions_1 = map(prevPos_1, function (value, key) {
                return value &lt;= destPos_1[key] ? 1 : -1;
            });
            var originalIntendedPos_1 = map(destPos_1, function (v) { return v; });
            var prevTime_1 = new Date().getTime();
            info_1.startTime = prevTime_1;
            (function loop() {
                self_1._raf = null;
                var currentTime = new Date().getTime();
                var ratio = (currentTime - info_1.startTime) / param.duration;
                var easingPer = self_1.easing(ratio);
                var toPos = self_1.axm.map(prevPos_1, function (pos, options, key) {
                    var nextPos = ratio >= 1
                        ? destPos_1[key]
                        : pos + info_1.delta[key] * (easingPer - prevEasingPer_1);
                    // Subtract distance from distance already moved.
                    // Recalculate the remaining distance.
                    // Fix the bouncing phenomenon by changing the range.
                    var circulatedPos = getCirculatedPos(nextPos, options.range, options.circular);
                    if (nextPos !== circulatedPos) {
                        // circular
                        var rangeOffset = directions_1[key] * (options.range[1] - options.range[0]);
                        destPos_1[key] -= rangeOffset;
                        prevPos_1[key] -= rangeOffset;
                    }
                    return circulatedPos;
                });
                var isCanceled = !self_1.em.triggerChange(toPos, false, prevPos_1);
                prevPos_1 = toPos;
                prevTime_1 = currentTime;
                prevEasingPer_1 = easingPer;
                if (easingPer >= 1) {
                    destPos_1 = self_1.getFinalPos(destPos_1, originalIntendedPos_1);
                    if (!equal(destPos_1, self_1.axm.get(Object.keys(destPos_1)))) {
                        self_1.em.triggerChange(destPos_1, true, prevPos_1);
                    }
                    complete();
                    return;
                }
                else if (isCanceled) {
                    self_1.finish(false);
                }
                else {
                    // animationEnd
                    self_1._raf = requestAnimationFrame(loop);
                }
            })();
        }
        else {
            this.em.triggerChange(param.destPos, true);
            complete();
        }
    };
    /**
     * Get estimated final value.
     *
     * If destPos is within the 'error range' of the original intended position, the initial intended position is returned.
     *   - eg. original intended pos: 100, destPos: 100.0000000004 ==> return 100;
     * If dest Pos is outside the 'range of error' compared to the originally intended pos, it is returned rounded based on the originally intended pos.
     *   - eg. original intended pos: 100.123 destPos: 50.12345 => return 50.123
     *
     * @param originalIntendedPos
     * @param destPos
     */
    AnimationManager.prototype.getFinalPos = function (destPos, originalIntendedPos) {
        var _this = this;
        // compare destPos and originalIntendedPos
        var ERROR_LIMIT = 0.000001;
        var finalPos = map(destPos, function (value, key) {
            if (value >= originalIntendedPos[key] - ERROR_LIMIT &amp;&amp; value &lt;= originalIntendedPos[key] + ERROR_LIMIT) {
                // In error range, return original intended
                return originalIntendedPos[key];
            }
            else {
                // Out of error range, return rounded pos.
                var roundUnit = _this.getRoundUnit(value, key);
                var result = roundNumber(value, roundUnit);
                return result;
            }
        });
        return finalPos;
    };
    AnimationManager.prototype.getRoundUnit = function (val, key) {
        var roundUnit = this.options.round; // manual mode
        var minRoundUnit = null; // auto mode
        // auto mode
        if (!roundUnit) {
            // Get minimum round unit
            var options = this.axm.getAxisOptions(key);
            minRoundUnit = inversePow(Math.max(getDecimalPlace(options.range[0]), getDecimalPlace(options.range[1]), getDecimalPlace(val)));
        }
        return minRoundUnit || roundUnit;
    };
    AnimationManager.prototype.getUserControll = function (param) {
        var userWish = param.setTo();
        userWish.destPos = this.axm.get(userWish.destPos);
        userWish.duration = minMax(userWish.duration, this.options.minimumDuration, this.options.maximumDuration);
        return userWish;
    };
    AnimationManager.prototype.animateTo = function (destPos, duration, option) {
        var _this = this;
        var param = this.createAnimationParam(destPos, duration, option);
        var depaPos = __assign({}, param.depaPos);
        var retTrigger = this.em.triggerAnimationStart(param);
        // to control
        var userWish = this.getUserControll(param);
        // You can't stop the 'animationStart' event when 'circular' is true.
        if (!retTrigger &amp;&amp; this.axm.every(userWish.destPos, function (v, opt) { return isCircularable(v, opt.range, opt.circular); })) {
            console.warn("You can't stop the 'animation' event when 'circular' is true.");
        }
        if (retTrigger &amp;&amp; !equal(userWish.destPos, depaPos)) {
            var inputEvent = option &amp;&amp; option.event || null;
            this.animateLoop({
                depaPos: depaPos,
                destPos: userWish.destPos,
                duration: userWish.duration,
                delta: this.axm.getDelta(depaPos, userWish.destPos),
                isTrusted: !!inputEvent,
                inputEvent: inputEvent,
                input: option &amp;&amp; option.input || null,
            }, function () { return _this.animationEnd(); });
        }
    };
    AnimationManager.prototype.easing = function (p) {
        return p > 1 ? 1 : this.options.easing(p);
    };
    AnimationManager.prototype.setTo = function (pos, duration) {
        if (duration === void 0) { duration = 0; }
        var axes = Object.keys(pos);
        this.grab(axes);
        var orgPos = this.axm.get(axes);
        if (equal(pos, orgPos)) {
            return this;
        }
        this.itm.setInterrupt(true);
        var movedPos = filter(pos, function (v, k) { return orgPos[k] !== v; });
        if (!Object.keys(movedPos).length) {
            return this;
        }
        movedPos = this.axm.map(movedPos, function (v, opt) {
            var range = opt.range, circular = opt.circular;
            if (circular &amp;&amp; (circular[0] || circular[1])) {
                return v;
            }
            else {
                return getInsidePosition(v, range, circular);
            }
        });
        if (equal(movedPos, orgPos)) {
            return this;
        }
        if (duration > 0) {
            this.animateTo(movedPos, duration);
        }
        else {
            this.em.triggerChange(movedPos);
            this.finish(false);
        }
        return this;
    };
    AnimationManager.prototype.setBy = function (pos, duration) {
        if (duration === void 0) { duration = 0; }
        return this.setTo(map(this.axm.get(Object.keys(pos)), function (v, k) { return v + pos[k]; }), duration);
    };
    return AnimationManager;
}());
export { AnimationManager };
//# sourceMappingURL=AnimationManager.js.map</code></pre>
        </article>
    </section>






        
        <!-- disqus code -->
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- // disqus code -->
        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Fri Nov 11 2022 03:36:08 GMT+0900 (대한민국 표준시)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/main.js"></script>
</body>
</html>
